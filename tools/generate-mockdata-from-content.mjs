#!/usr/bin/env node
import fs from 'fs';
import path from 'path';
import matter from 'gray-matter';

const root = path.resolve('.');
const contentDir = path.join(root, 'content');
const mockDataPath = path.join(root, 'project-hub-x', 'src', 'data', 'mockData.ts');

const collections = [
  'readymadeprojects',
  'faq',
  'clienttestimonials',
  'howitworkssteps',
  'customprojectrequests',
  'developerprofiles',
];

function ensureArray(v) { return Array.isArray(v) ? v : (v ? [v] : []); }
function toDate(value) {
  if (!value) return undefined;
  const d = new Date(value);
  return isNaN(d.getTime()) ? undefined : d;
}

function loadCollection(name) {
  const dir = path.join(contentDir, name);
  if (!fs.existsSync(dir)) return [];
  const files = fs.readdirSync(dir).filter(f => f.endsWith('.md') || f.endsWith('.yml') || f.endsWith('.yaml') || f.endsWith('.json'));
  const items = [];
  for (const file of files) {
    const full = path.join(dir, file);
    let data;
    if (file.endsWith('.json')) {
      data = JSON.parse(fs.readFileSync(full, 'utf8'));
    } else {
      const parsed = matter.read(full);
      data = { ...parsed.data };
    }
    // Normalize date fields
    if (data._createdDate) data._createdDate = toDate(data._createdDate);
    if (data._updatedDate) data._updatedDate = toDate(data._updatedDate);
    if (data.testimonialDate) data.testimonialDate = toDate(data.testimonialDate);
    items.push(data);
  }
  return items;
}

function genTsArray(name, items) {
  const ts = JSON.stringify(items, (k, v) => {
    if (v instanceof Date) return v.toISOString();
    return v;
  }, 2)
    .replace(/"([A-Za-z0-9_]+)":/g, '$1:')
    .replace(/"/g, '\\"');
  return `export const mock${name[0].toUpperCase() + name.slice(1)} = JSON.parse("${ts}");\n`;
}

function generate() {
  const data = {};
  for (const c of collections) {
    data[c] = loadCollection(c);
  }

  const header = `/**\n * Auto-generated from content/ by tools/generate-mockdata-from-content.mjs\n * Do not edit this file directly. Edit content and re-run the generator.\n */\n\nimport type { \n  ReadyMadeProjects, \n  ClientTestimonials, \n  CustomProjectRequests,\n  DeveloperProfiles,\n  FrequentlyAskedQuestions,\n  HowItWorksSteps \n} from '@/entities';\n\n`;

  const blocks = [];
  blocks.push(`export const mockProjects: ReadyMadeProjects[] = JSON.parse("${JSON.stringify(data.readymadeprojects).replace(/"/g, '\\"')}");\n`);
  blocks.push(`export const mockTestimonials: ClientTestimonials[] = JSON.parse("${JSON.stringify(data.clienttestimonials).replace(/"/g, '\\"')}");\n`);
  blocks.push(`export const mockFAQs: FrequentlyAskedQuestions[] = JSON.parse("${JSON.stringify(data.faq).replace(/"/g, '\\"')}");\n`);
  blocks.push(`export const mockHowItWorks: HowItWorksSteps[] = JSON.parse("${JSON.stringify(data.howitworkssteps).replace(/"/g, '\\"')}");\n`);
  blocks.push(`export const mockCustomRequests: CustomProjectRequests[] = JSON.parse("${JSON.stringify(data.customprojectrequests).replace(/"/g, '\\"')}");\n`);
  blocks.push(`export const mockDevelopers: DeveloperProfiles[] = JSON.parse("${JSON.stringify(data.developerprofiles).replace(/"/g, '\\"')}");\n`);

  const output = header + blocks.join('\n');
  fs.writeFileSync(mockDataPath, output);
  console.log('Updated mockData.ts from content/.');
}

generate();
